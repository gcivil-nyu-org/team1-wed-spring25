{% extends "base.html" %}
{% load static %}

{% block title %}Chat{% endblock %}

{% block content %}

<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }

  .chat-container {
    display: flex;
    width: 100%;
    height: calc(100vh - 40px); 
    margin: 0;
    border-radius: 0;
    overflow: hidden;
    box-shadow: none;
    position: relative;
    margin-top: -20px;
  }
  
  .chat-list {
    width: 350px;
    background-color: #f8f8f8;
    border-right: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }
  
  .chat-list-header {
    padding: 15px;
    background-color: #f0f0f0;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .chat-item i {
    font-style: normal;
  }

  .chat-items {
    flex: 1;
    overflow-y: auto;
  }
  
  .chat-item {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .chat-item:hover {
    background-color: #f0f0f0;
  }
  
  .chat-item.active {
    background-color: #e7f0ff;
    border-left: 3px solid #3c83f6;
  }
  
  .chat-avatar {
    width: 48px;
    height: 48px;
    border-radius: 24px;
    margin-right: 12px;
    background-color: #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #666;
  }
  
  .chat-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .chat-info {
    flex: 1;
    padding: 8px 0;
    min-width: 0;
    position: relative;
  }
  
  .chat-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  
  .chat-name {
    font-weight: 600;
    font-size: 16px;
    color: #333;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .chat-options {
    cursor: pointer;
    opacity: 0.5;
    transition: opacity 0.2s;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.05);
    font-size: 16px;
    line-height: 1;
  }

  .chat-item:hover .chat-options {
    opacity: 1;
  }

  .chat-options-menu {
    position: absolute;
    right: 10px;
    top: 35px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    width: 150px;
    z-index: 100;
    display: none;
  }

  .chat-options-menu.active {
    display: block;
  }

  .chat-options-menu ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .chat-options-menu li {
    padding: 10px 15px;
    cursor: pointer;
  }

  .chat-options-menu li:hover {
    background-color: #f8f8f8;
  }

  .chat-options-menu li.delete-chat {
    color: #ff6b6b;
  }

  .chat-info-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    color: #666;
  }

  .chat-item:hover .delete-chat-button {
    opacity: 1;
  }
  
  .message-time-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .chat-last-message {
    flex: 1;
    font-size: 13px;
    color: #777;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 260px;
  }

  .chat-time {
    font-size: 12px;
    color: #999;
    margin-left: 8px;
    white-space: nowrap;
  }
  
  .chat-detail {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    background-color: white;
    height: 100%;
    overflow: hidden;
    width: 600px;
  }
  
  .chat-detail-header {
    padding: 15px;
    background-color: #f8f8f8;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .chat-detail-info {
    display: flex;
    align-items: center;
  }
  
  .chat-detail-name {
    font-weight: 500;
    margin-left: 12px;
  }
  
  .chat-detail-actions {
    display: flex;
  }
  
  .chat-detail-actions a {
    margin-left: 15px;
    color: #666;
  }
  
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background-color: #f5f5f5;
  }
  
  .message {
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
    position: relative;
  }
  
  .message-sender {
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 4px;
    color: #3c83f6;
  }
  
  .message-content {
    padding: 10px 15px;
    padding-right: 35px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    max-width: 80%;
    align-self: flex-start;
    position: relative;
  }
  
  .message.sent .message-content {
    display: inline-block; 
    min-height: 24px;
    background-color: #dcf8c6;
    align-self: flex-end;
    position: relative;
  }
  
  .message-time {
    font-size: 11px;
    color: #999;
    margin-top: 4px;
    align-self: flex-end;
  }
  
  .chat-input {
    padding: 15px;
    background-color: #f8f8f8;
    border-top: 1px solid #e0e0e0;
    display: flex;
  }
  
  .chat-input form {
    display: flex;
    width: 100%;
  }
  
  .chat-input input {
    flex: 1;
    padding: 10px 15px;
    border-radius: 20px;
    border: 1px solid #ddd;
    margin-right: 10px;
  }
  
  .chat-input button {
    padding: 8px 16px;
    background-color: #3c83f6;
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
  }
  
  .no-chat-selected {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    color: #666;
  }
  
  .no-chat-selected i {
    font-size: 48px;
    margin-bottom: 15px;
    color: #ddd;
  }

  .message-options {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.05);
    font-size: 16px; 
    line-height: 1;
  }

  .message:hover .message-options {
    opacity: 1;
  }

  .message-options-menu {
    position: absolute;
    right: 30px;
    top: 0;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    width: 150px;
    z-index: 100;
    display: none;
  }

  .message-options-menu.active {
    display: block;
  }

  .message-options-menu ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .message-options-menu li {
    padding: 10px 15px;
    cursor: pointer;
  }

  .message-options-menu li:hover {
    background-color: #f8f8f8;
  }

  .message-options-menu li.delete {
    color: #ff6b6b;
  }
</style>

<div class="chat-container">
  <!-- Chat List (Left Side) -->
  <div class="chat-list">
    <div class="chat-list-header">
      <h2>Chats</h2>
    </div>
    
    <div class="chat-items">
      {% for chat in chats %}
        <div class="chat-item {% if current_chat and c.id == current_chat.id %}active{% endif %}" 
             onclick="window.location.href='{% url 'chat_detail' chat.chat_hash %}'">
          <div class="chat-avatar">
            {% if chat.user1 == request.user %}
              <!-- {{ chat.user2.first_name|first }} -->
              {{ chat.display_name|first }}
            {% else %}
              <!-- {{ chat.user1.first_name|first }} -->
              {{ chat.display_name|first }}
            {% endif %}
          </div>
          <div class="chat-info">
            <div class="chat-header">
              <div class="chat-name">
                {{ chat.display_name}}
              </div>
              <div class="chat-options">⋮</div>
                <div class="chat-options-menu">
                  <ul>
                    <li class="delete-chat" data-chat-hash="{{ chat.chat_hash }}">Delete chat</li>
                  </ul>
                </div>
            </div>
            <div class="chat-info-details">
              <div class="chat-last-message">
                {% if chat.messages.last %}
                  {{ chat.messages.last.content|truncatechars:30 }}
                {% else %}
                  No messages yet
                {% endif %}
              </div>
              <div class="chat-time">{{ chat.last_time|date:"M d" }}</div>
              
            </div>
          </div>
        </div>
      {% empty %}
        <div class="chat-item">
          <div class="chat-info text-center py-4">
            <p>No chats yet</p>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  
  <!-- Chat Detail (Right Side) -->
  <div class="chat-detail">
    {% if current_chat %}
      <div class="chat-detail-header">
        <div class="chat-detail-info">
          <div class="chat-avatar">
            {{ current_chat.display_name|first }}
          </div>
          <div class="chat-detail-name">
              {{ current_chat.display_name}}
          </div>
        </div>
        <div class="chat-detail-actions">
          <a href="{% url 'delete_chat' current_chat.chat_hash %}" onclick="return confirm('Are you sure you want to delete this chat?');">
            <i class="fas fa-trash"></i>
          </a>
        </div>
      </div>
      
      <div class="chat-messages" id="chat-messages">
        {% for message in messages %}
          <div class="message {% if message.sender == request.user %}sent{% endif %}">
            {% if message.sender != request.user %}
              <div class="message-sender">
                {% if message.sender.role == "training_provider" %}
                  {{ message.sender.provider_profile.name }}
                {% else %}
                  {{ message.sender.username }}
                {% endif %}
              </div>
            {% endif %}
            <div class="message-content">
              {{ message.content }}
              <div class="message-options">⋮</div>
              <div class="message-options-menu">
                <ul>
                  <li class="delete" data-message-id="{{ message.id }}">Delete</li>
                </ul>
              </div>
            </div>
            <div class="message-time">{{ message.local_send_time|date:"H:i" }}</div>
          </div>
        {% empty %}
          <div class="text-center py-4 text-muted">
            <p>No messages yet. Start the conversation!</p>
          </div>
        {% endfor %}
      </div>
      
      <div class="chat-input">
        <form method="post" id="chat-form">
          {% csrf_token %}
          <input type="text" name="content" placeholder="Type a message…" autocomplete="off">
          <button type="submit">Send</button>
        </form>
      </div>
      
      <script>
        // Scroll to bottom of messages
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // WebSocket connection
        const chatSocket = new WebSocket(
          (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + 
          window.location.host + 
          '/ws/chat/{{ current_chat.chat_hash }}/'
        );

        chatSocket.onopen = function(e) {
          console.log("WebSocket connection established");
        };
        
        chatSocket.onerror = function(e) {
          console.error("WebSocket error:", e);
        };
        
        chatSocket.onclose = function(e) {
          console.log("WebSocket closed:", e.code, e.reason);
        };
        
        chatSocket.onmessage = function(e) {
          const data = JSON.parse(e.data);
          const isCurrentUser = data.sender === "{{ request.user.username }}";
          const messageId = data.message_id || '';
          
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${isCurrentUser ? 'sent' : ''}`;
          
          if (!isCurrentUser) {
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = data.sender;
            messageDiv.appendChild(senderDiv);
          }
          
          const contentDiv = document.createElement('div');
          contentDiv.className = 'message-content';
          contentDiv.textContent = data.message;
          messageDiv.appendChild(contentDiv);
          
          const timeDiv = document.createElement('div');
          timeDiv.className = 'message-time';
          const now = new Date();
          timeDiv.textContent = now.getHours().toString().padStart(2, '0') + ':' + 
                              now.getMinutes().toString().padStart(2, '0');
          messageDiv.appendChild(timeDiv);
          
          if (isCurrentUser) {
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'message-options';
            optionsDiv.textContent = '⋮';
            messageDiv.appendChild(optionsDiv);
            
            const optionsMenuDiv = document.createElement('div');
            optionsMenuDiv.className = 'message-options-menu';
            optionsMenuDiv.innerHTML = `
              <ul>
                <li class="delete" data-message-id="${messageId}">Delete</li>
              </ul>
            `;
            messageDiv.appendChild(optionsMenuDiv);
            
            optionsDiv.addEventListener('click', function(e) {
              e.stopPropagation();
              closeAllMenus();
              optionsMenuDiv.classList.add('active');
            });
          }

          document.getElementById('chat-messages').appendChild(messageDiv);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
          bindMenuEvents();
        };
        
        const chatForm = document.getElementById('chat-form');
        chatForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const messageInput = document.querySelector('[name="content"]');
          const message = messageInput.value.trim();

          if (message) {
            chatSocket.send(JSON.stringify({
              'message': message,
              'sender': "{{ request.user.username }}"
            }));
          }
          
          messageInput.value = '';
        });

        function closeAllMenus() {
          const allMenus = document.querySelectorAll('.message-options-menu.active');
          allMenus.forEach(menu => menu.classList.remove('active'));
        }

        function bindMenuEvents() {
          document.querySelectorAll('.message-options').forEach(option => {
            option.addEventListener('click', function(e) {
              e.stopPropagation();
              closeAllMenus();
              this.nextElementSibling.classList.add('active');
            });
          });
          
          document.querySelectorAll('.message-options-menu .delete').forEach(deleteOption => {
            deleteOption.addEventListener('click', function(e) {
              e.stopPropagation();
              const messageId = this.getAttribute('data-message-id');
              if (confirm('Are you sure you want to delete this message?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/chat/delete_message/${messageId}/`;
                
                const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrf;
                
                form.appendChild(csrfInput);
                document.body.appendChild(form);
                form.submit();
              }
            });
          });
        }

        document.addEventListener('click', function() {
          closeAllMenus();
        });

        bindMenuEvents();

        chatSocket.onclose = function(e) {
          console.error('Chat socket closed unexpectedly');
        };
      </script>
    {% else %}
      <div class="no-chat-selected">
        <i class="fas fa-comments"></i>
        <h3>Welcome to Chat</h3>
        <p>Select a conversation to start chat</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    function closeChatMenus() {
    const allMenus = document.querySelectorAll('.chat-options-menu.active');
      allMenus.forEach(menu => menu.classList.remove('active'));
    }

    document.querySelectorAll('.chat-options').forEach(option => {
      option.addEventListener('click', function(e) {
        e.stopPropagation();
        closeChatMenus();
        this.nextElementSibling.classList.add('active');
      });
    });

    document.querySelectorAll('.chat-options-menu .delete-chat').forEach(deleteOption => {
      deleteOption.addEventListener('click', function(e) {
        e.stopPropagation();
        const chatHash = this.getAttribute('data-chat-hash');
        if (chatHash && confirm('Are you sure you want to clear all chat history?')) {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/chat/delete_chat/${chatHash}/`;
          
          const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrfmiddlewaretoken';
          csrfInput.value = csrf;
          
          form.appendChild(csrfInput);
          document.body.appendChild(form);
          form.submit();
        }
      });
    });

    document.addEventListener('click', function() {
      closeChatMenus();
    });

  });
  </script>

{% endblock %}