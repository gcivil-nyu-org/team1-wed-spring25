{% extends "template.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/bookmark.css' %}">


<div class="modal fade" id="bookmarkModal" tabindex="-1" aria-labelledby="bookmarkModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-modal">
      <form id="bookmarkForm">
        {% csrf_token %}
        <input type="hidden" name="course_id" id="modalCourseId">

        <div class="modal-header border-0">
          <h5 class="modal-title modal-header-text" id="bookmarkModalLabel">
            ➕ Add Bookmark for <span id="courseNameDisplay"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div id="bookmarkError" class="alert alert-info" style="display: none;margin-left: 1rem; margin-right: 1rem;"></div>
        <div id="bookmarkSuccess" class="alert alert-info" style="display: none;margin-left: 1rem; margin-right: 1rem;"></div>

        <div class="modal-body">
          {% if bookmark_lists %}
            <label for="bookmarkList" class="modal-label">Choose Bookmark List:</label>
            <select name="bookmark_list" id="bookmarkList" class="modal-select">
              {% for list in bookmark_lists %}
              <option value="{{ list.list_id }}"
                {% if default_bookmark_list and list.list_id == default_bookmark_list.list_id %} selected {% endif %}>
                {{ list.name }}
              </option>
              {% endfor %}
            </select>
          {% else %}
            <p class="empty-message">You don't have any bookmark lists yet.</p>
          {% endif %}

          <div class="modal-footer aligned-footer border-0">
            {% if bookmark_lists %}
              <button type="button" class="cancel-button" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="create-button">Add</button>
            {% else %}
              <a href="{% url 'create_bookmark_list' %}" class="create-button">➕ Create New List</a>
              <button type="button" class="cancel-button" data-bs-dismiss="modal">Cancel</button>
            {% endif %}
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function openBookmarkModal(courseId, courseName) {
    const modal = new bootstrap.Modal(document.getElementById('bookmarkModal'));
    document.getElementById("modalCourseId").value = courseId;
    document.getElementById("courseNameDisplay").textContent = courseName;
    document.getElementById("bookmarkError").style.display = "none";
    modal.show();
  }

  function closeBookmarkModal() {
    const modalElement = bootstrap.Modal.getInstance(document.getElementById('bookmarkModal'));
    modalElement.hide();
  }

  document.getElementById("bookmarkForm")?.addEventListener("submit", async function (e) {
    e.preventDefault();
    const courseId = this.getAttribute("data-course-id") || document.getElementById("modalCourseId").value;
    const bookmarkListId = document.getElementById("bookmarkList").value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const response = await fetch(`/bookmarks/courses/${courseId}/add_bookmark/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrfToken,
      },
      body: `bookmark_list=${bookmarkListId}`
    });

    const resultHTML = await response.text();

    if (response.redirected) {
      document.getElementById("bookmarkSuccess").textContent = "✅ Course bookmarked successfully!";
      document.getElementById("bookmarkSuccess").style.display = "block";
      setTimeout(() => {
        closeBookmarkModal();
        location.reload();
      }, 2000);
    } else {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = resultHTML;
      const messageText = tempDiv.querySelector('.alert-info');
      if (messageText) {
        const errorBox = document.getElementById("bookmarkError");
        errorBox.innerHTML = messageText.innerHTML;
        errorBox.style.display = "block";
      }
    }
  });
</script>

{% endblock %}